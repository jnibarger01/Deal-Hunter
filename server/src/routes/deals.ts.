import { Router } from 'express';
import { prisma } from '../config/prisma';
import { TMVCalculator } from '../domain/tmv/calculator';
import { DealScorer } from '../domain/scoring/composite';

const router = Router();

// GET /api/deals - List all deals with TMV + scores
router.get('/', async (req, res) => {
  const { category, minScore, limit = 50 } = req.query;
  
  const deals = await prisma.deal.findMany({
    where: {
      ...(category && { category: category as string }),
      score: {
        compositeRank: { gte: minScore ? Number(minScore) : 0 },
      },
    },
    include: {
      tmvResult: true,
      score: true,
    },
    orderBy: {
      score: { compositeRank: 'desc' },
    },
    take: Number(limit),
  });
  
  res.json(deals);
});

// POST /api/deals/ingest - Ingest new listings
router.post('/ingest', async (req, res) => {
  const { source, listings } = req.body;
  
  // Normalize + insert
  const deals = await Promise.all(
    listings.map((listing: any) =>
      prisma.deal.upsert({
        where: { source_sourceId: { source, sourceId: listing.id } },
        create: {
          source,
          sourceId: listing.id,
          title: listing.title,
          price: listing.price,
          condition: listing.condition,
          category: listing.category,
          location: listing.location,
          url: listing.url,
        },
        update: {
          price: listing.price,
        },
      })
    )
  );
  
  res.json({ ingested: deals.length });
});

// POST /api/deals/:id/calculate-tmv
router.post('/:id/calculate-tmv', async (req, res) => {
  const { id } = req.params;
  
  const deal = await prisma.deal.findUnique({
    where: { id },
    include: { samples: true },
  });
  
  if (!deal) {
    return res.status(404).json({ error: 'Deal not found' });
  }
  
  const config = {
    minSamples: 8,
    freshnessWindow: 180,
    decayRate: 0.01,
    minConfidence: 0.4,
  };
  
  const calculator = new TMVCalculator(config);
  const result = calculator.calculate(deal.samples);
  
  if (!result) {
    return res.status(400).json({ error: 'Insufficient data for TMV' });
  }
  
  const tmv = await prisma.tMVResult.upsert({
    where: { dealId: id },
    create: { dealId: id, ...result },
    update: result,
  });
  
  res.json(tmv);
});

export default router;
