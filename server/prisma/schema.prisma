// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and user management
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String?
  lastName      String?
  role          String   @default("user") // user, admin
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  watchlistItems WatchlistItem[]
  portfolioItems PortfolioItem[]
  alerts         Alert[]
  refreshTokens  RefreshToken[]

  @@index([email])
  @@map("users")
}

// Refresh token for JWT authentication
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Deal model - core entity representing marketplace deals
model Deal {
  id              String   @id @default(uuid())
  title           String
  description     String?  @db.Text
  price           Float
  marketValue     Float
  estimatedProfit Float
  dealScore       Float    // 0-100
  roi             Float    // Return on investment percentage
  category        String
  condition       String   // new, like-new, good, fair, poor
  imageUrl        String?
  itemUrl         String
  location        String?
  marketplace     String   // craigslist, ebay, facebook
  marketplaceId   String?  @unique // Unique ID from the marketplace

  // AI Analysis fields
  repairDifficulty String? // easy, moderate, hard
  likelyIssues     String? @db.Text
  partsEstimate    Float?
  marketTrend      String? @db.Text
  negotiationTips  String? @db.Text

  status          String   @default("active") // active, sold, expired
  expiresAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  watchlistItems WatchlistItem[]
  portfolioItems PortfolioItem[]

  @@index([marketplace])
  @@index([category])
  @@index([dealScore])
  @@index([createdAt])
  @@index([status])
  @@map("deals")
}

// Watchlist - users can save deals to watch
model WatchlistItem {
  id        String   @id @default(uuid())
  userId    String
  dealId    String
  notes     String?  @db.Text
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([userId, dealId])
  @@index([userId])
  @@index([dealId])
  @@map("watchlist_items")
}

// Portfolio - track purchased items and their outcomes
model PortfolioItem {
  id                String    @id @default(uuid())
  userId            String
  dealId            String?
  title             String
  purchasePrice     Float
  purchaseDate      DateTime
  sellPrice         Float?
  sellDate          DateTime?
  actualProfit      Float?
  status            String    @default("owned") // owned, listed, sold
  platform          String?   // Where it was sold
  repairCost        Float?
  repairTime        Int?      // Hours spent on repairs
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal Deal? @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([purchaseDate])
  @@map("portfolio_items")
}

// Alerts - notify users of specific deal criteria
model Alert {
  id          String   @id @default(uuid())
  userId      String
  name        String
  category    String?
  marketplace String?
  minDealScore Float?
  maxPrice    Float?
  keywords    String?
  location    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@map("alerts")
}

// Marketplace sync tracking
model MarketplaceSync {
  id            String   @id @default(uuid())
  marketplace   String   @unique
  lastSyncAt    DateTime
  itemsSynced   Int
  status        String   // success, failed, in_progress
  errorMessage  String?  @db.Text
  createdAt     DateTime @default(now())

  @@index([marketplace])
  @@index([lastSyncAt])
  @@map("marketplace_syncs")
}
